{
  "$schema": "https://railway.app/railway.schema.json",
  "services": {
    "postgres": {
      "image": "postgres:16-alpine",
      "variables": {
        "POSTGRES_USER": "postgres",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}",
        "POSTGRES_DB": "railway",
        "DATABASE_URL": "postgresql://${{POSTGRES_USER}}:${{POSTGRES_PASSWORD}}@${{RAILWAY_PRIVATE_DOMAIN}}:5432/${{POSTGRES_DB}}"
      }
    },
    "redis": {
      "image": "redis:7-alpine",
      "variables": {
        "REDIS_PASSWORD": "${{REDIS_PASSWORD}}",
        "REDIS_URL": "redis://:${{REDIS_PASSWORD}}@${{RAILWAY_PRIVATE_DOMAIN}}:6379"
      }
    },
    "api-gateway": {
      "build": {
        "builder": "NIXPACKS",
        "root": "platform",
        "buildCommand": "pnpm install && pnpm build --filter=api-gateway...",
        "watchPatterns": [
          "packages/api-gateway/**",
          "packages/common/**"
        ]
      },
      "deploy": {
        "startCommand": "npm run start:api"
      },
      "variables": {
        "NIXPACKS_PROVIDERS": "node",
        "NODE_ENV": "production",
        "PORT": "3000",
        "HOST": "0.0.0.0",
        "DATABASE_URL": "${{postgres.DATABASE_URL}}",
        "REDIS_URL": "${{redis.REDIS_URL}}",
        "INGESTION_SERVICE_URL": "http://${{ingestion-service.HOST}}:${{ingestion-service.PORT}}",
        "RATING_ENGINE_URL": "http://${{rating-engine.HOST}}:${{rating-engine.PORT}}",
        "RATE_LIMIT_MAX": "60",
        "RATE_LIMIT_WINDOW": "1 minute"
      }
    },
    "ingestion-service": {
      "build": {
        "builder": "NIXPACKS",
        "root": "platform",
        "buildCommand": "pnpm install && pnpm build --filter=ingestion-service...",
        "watchPatterns": [
          "packages/ingestion-service/**",
          "packages/common/**"
        ]
      },
      "deploy": {
        "startCommand": "npm run start:ingestion"
      },
      "variables": {
        "NIXPACKS_PROVIDERS": "node",
        "NODE_ENV": "production",
        "PORT": "8081",
        "HOST": "0.0.0.0",
        "DATABASE_URL": "${{postgres.DATABASE_URL}}",
        "REDIS_URL": "${{redis.REDIS_URL}}",
        "RATE_LIMIT_MAX": "1000",
        "RATE_LIMIT_WINDOW_MS": "60000",
        "QUEUE_NAME": "usage-events",
        "QUEUE_CONCURRENCY": "10"
      }
    },
    "rating-engine": {
      "build": {
        "builder": "NIXPACKS",
        "root": "platform",
        "buildCommand": "pnpm install && pnpm build --filter=rating-engine...",
        "watchPatterns": [
          "packages/rating-engine/**",
          "packages/common/**"
        ]
      },
      "deploy": {
        "startCommand": "npm run start:rating"
      },
      "variables": {
        "NIXPACKS_PROVIDERS": "node",
        "NODE_ENV": "production",
        "PORT": "3002",
        "HOST": "0.0.0.0",
        "DATABASE_URL": "${{postgres.DATABASE_URL}}",
        "OPENAI_API_KEY": "",
        "ANTHROPIC_API_KEY": ""
      }
    }
  }
}