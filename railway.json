{
  "$schema": "https://railway.app/railway.schema.json",
  "services": {
    "postgres": {
      "image": "postgres:16-alpine",
      "variables": {
        "POSTGRES_USER": "postgres",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}",
        "POSTGRES_DB": "railway"
      }
    },
    "redis": {
      "image": "redis:7-alpine",
      "variables": {
        "REDIS_PASSWORD": "${{REDIS_PASSWORD}}"
      }
    },
    "api-gateway": {
      "build": {
        "builder": "NIXPACKS",
        "buildCommand": "cd platform && pnpm install && pnpm build --filter=api-gateway..."
      },
      "deploy": {
        "startCommand": "cd platform && node packages/api-gateway/dist/index.js",
        "restartPolicyType": "ON_FAILURE"
      },
      "variables": {
        "NODE_ENV": "production",
        "PORT": "3000",
        "HOST": "0.0.0.0",
        "DATABASE_URL": "${{postgres.DATABASE_URL}}",
        "REDIS_URL": "${{redis.REDIS_URL}}",
        "INGESTION_SERVICE_URL": "http://${{ingestion-service.HOST}}:${{ingestion-service.PORT}}",
        "RATING_ENGINE_URL": "http://${{rating-engine.HOST}}:${{rating-engine.PORT}}",
        "RATE_LIMIT_MAX": "60",
        "RATE_LIMIT_WINDOW": "1 minute"
      }
    },
    "ingestion-service": {
      "build": {
        "builder": "NIXPACKS",
        "buildCommand": "cd platform && pnpm install && pnpm build --filter=ingestion-service..."
      },
      "deploy": {
        "startCommand": "cd platform && node packages/ingestion-service/dist/index.js",
        "restartPolicyType": "ON_FAILURE"
      },
      "variables": {
        "NODE_ENV": "production",
        "PORT": "8081",
        "HOST": "0.0.0.0",
        "DATABASE_URL": "${{postgres.DATABASE_URL}}",
        "REDIS_URL": "${{redis.REDIS_URL}}",
        "RATE_LIMIT_MAX": "1000",
        "RATE_LIMIT_WINDOW_MS": "60000",
        "QUEUE_NAME": "usage-events",
        "QUEUE_CONCURRENCY": "10"
      }
    },
    "rating-engine": {
      "build": {
        "builder": "NIXPACKS",
        "buildCommand": "cd platform && pnpm install && pnpm build --filter=rating-engine..."
      },
      "deploy": {
        "startCommand": "cd platform && node packages/rating-engine/dist/index.js",
        "restartPolicyType": "ON_FAILURE"
      },
      "variables": {
        "NODE_ENV": "production",
        "PORT": "3002",
        "HOST": "0.0.0.0",
        "DATABASE_URL": "${{postgres.DATABASE_URL}}",
        "OPENAI_API_KEY": "",
        "ANTHROPIC_API_KEY": ""
      }
    }
  }
}